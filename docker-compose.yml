services:
  ollama:
    image: ollama/ollama:latest
    container_name: licitai-ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - licitai-network
    restart: always

  agente-gateway:
    build:
      context: ./services/agente
    container_name: licitai-agente
    environment:
      - OLLAMA_HOST=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.1:8b}
      - DB_URL=http://memoria-db:8083
      - OCR_URL=http://ocr-vlm:8082
      - DOCX_URL=http://generador-docx:8081
    volumes:
      - ./data/workspaces:/app/data/workspaces
    ports:
      - "${AGENTE_PORT:-8080}:8080"
    networks:
      - licitai-network
    depends_on:
      - ollama
      - memoria-db
      - ocr-vlm

  generador-docx:
    build:
      context: ./services/docx-gen
    container_name: licitai-docx
    volumes:
      - ./data/workspaces:/app/data/workspaces
    ports:
      - "${DOCX_PORT:-8081}:8081"
    networks:
      - licitai-network

  ocr-vlm:
    build:
      context: ./services/ocr-vlm
    container_name: licitai-ocr-vlm
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    ports:
      - "8082:8082"
    volumes:
      - hf_cache:/root/.cache/huggingface
    networks:
      - licitai-network

  memoria-db:
    build:
      context: ./services/memoria
    container_name: licitai-memoria
    volumes:
      - ./data/db:/app/data/db
      - ./data/workspaces:/app/data/workspaces
    ports:
      - "${MEMORY_PORT:-8083}:8083"
    networks:
      - licitai-network

  dashboard:
    build:
      context: ./services/dashboard
    container_name: licitai-dashboard
    volumes:
      - ./services/dashboard/public:/app/public
    ports:
      - "${DASHBOARD_PORT:-3000}:3000"
    networks:
      - licitai-network
    depends_on:
      - agente-gateway

networks:
  licitai-network:
    driver: bridge

volumes:
  ollama_data:
  hf_cache:
